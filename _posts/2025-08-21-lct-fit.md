---
layout: post
title:  "Fitting Parameters for the Linearly Transformed Cosine"
date:   2025-08-21 16:05:00 +0800
use_math: true
---

This blog post explains the thoughts and implmentation details behind the fitting of Linearly Transformed Cosine (LTC) parameters to GGX BRDF. Largely inspired by [Eric Heitz's LTC research](https://eheitzresearch.wordpress.com/415-2/).

Also accounts for implementation caveats mentioned in the lecture [Real-Time Area Lighting:
a Journey from Research to Production](https://advances.realtimerendering.com/s2016/s2016_ltc_rnd.pdf) by Stephen Hill.

The goal is to generate multiple textures that store tabulated parameters that represent $\mathbf{M}$, parameterized by viewing angle $\theta_v$ and roughness $\sqrt{\alpha}$

$$
\mathbf{M} = \mathbf{B}\mathbf{m}
$$

$\mathbf{m}$ is a transformation that scales the cosine lobe in $x$ and $y$ direction, in the meantime shearing $x$ with respect to $z$. Jacobian of this transformation will ensure $z$ component being scaled accordingly to keep the transformed distribution normalized.

$$
\mathbf{m} =
\begin{bmatrix}
m_{11} & 0 & m_{13} \\
0 & m_{22} & 0 \\
0 & 0 & 1
\end{bmatrix}
$$

$\mathbf{B}$ is a rotation matrix around the $+y$ axis:

$$
\mathbf{B} = 
\begin{bmatrix}
\cos\bar{\theta_i} & 0 & -\sin\bar{\theta_i} \\
0 & 1 & 0 \\
\sin\bar{\theta_i} & 0 & \cos\bar{\theta_i}
\end{bmatrix}
$$

$\theta_i$ is the polar angle of weighted average incident direction $\bar{\omega_i}$ given an outgoing direction $\omega_o$:

$$
\bar{\omega_i} = \int_{\Omega} f_r(\omega_i, \omega_o)\cos\theta_i\omega_id\omega_i
$$

Notice the similarity between the above weighted average and the definition of albedo:

$$
Albedo = \int_{\Omega} f_r(\omega_i, \omega_o)\cos\theta_id\omega_i
$$

Since $\bar{\omega_i}$ is typically derived from a known BRDF (in our case, GGX), only the three scaling and shearing parameters of the matrix $\mathbf{m}$ require fitting. This separation of rotation from shearing-scaling factors, as opposed to directly fitting all five parameters of $\mathbf{M}$, reduces the likelihood of converging to a local minimum. Consequently, it yields more consistent results across adjacent entries in the resulting LUTs.

Expanded form of $\mathbf{M}$:

$$
\mathbf{M}
 = \begin{bmatrix}
m_{11}\cos\bar{\theta_i} & 0 & m_{13}\cos\bar{\theta_i}-\sin\bar{\theta_i} \\
0 & m_{22} & 0 \\
m_{11}\sin\bar{\theta_i} & 0 & m_{13}\sin\bar{\theta_i}+\cos\bar{\theta_i}
\end{bmatrix}
 = \begin{bmatrix}
a & 0 & b \\
0 & c & 0 \\
d & 0 & e
\end{bmatrix}
$$

The LTC paper divides $\mathbf{M}$ by its bottom right component $e$ to save one tabulated parameter. But in practice it is seen as a "false economy" because a second texture storing albedo has to be introduced regardless. We compute and tabulate this "normalized" matrix only to compare against the results given by the author.

$$
\mathbf{\hat{M}}
 = \frac{1}{e}\mathbf{M}
 = \begin{bmatrix}
\dfrac{a}{e} & 0 & \dfrac{b}{e} \\[8pt]
0 & \dfrac{c}{e} & 0 \\[8pt]
\dfrac{d}{e} & 0 & 1 \\[8pt]
\end{bmatrix}
 = \begin{bmatrix}
\hat{a} & 0 & \hat{b} \\[8pt]
0 & \hat{c} & 0 \\[8pt]
\hat{d} & 0 & 1 \\[8pt]
\end{bmatrix}
$$

It is also convenient to write paramters of $\mathbf{M^{-1}}$ and $\mathbf{\hat{M}^{-1}}$ to an LUT for later use in real-time polygonal lighting.

$$
\mathbf{M^{-1}}
 = \begin{bmatrix}
\dfrac{e}{\Delta} & 0 & -\dfrac{b}{\Delta} \\[8pt]
0 & \dfrac{1}{c} & 0 \\[8pt]
-\dfrac{d}{\Delta} & 0 & \dfrac{a}{\Delta}\\[8pt]
\end{bmatrix}
$$

where $\Delta = \det{\mathbf{M}}/c = ae - bd$

Similarly, introduce $\hat{\Delta} = \det{\mathbf{\hat{M}}}/\hat{c} = \hat{a} - \hat{b}\hat{d}$, we can write:

$$
\mathbf{\hat{M}^{-1}}
= \begin{bmatrix}
\dfrac{1}{\hat{\Delta}} & 0 & -\dfrac{\hat{b}}{\hat{\Delta}} \\[8pt]
0 & \dfrac{1}{\hat{c}} & 0 \\[8pt]
-\dfrac{\hat{d}}{\hat{\Delta}} & 0 & \dfrac{\hat{a}}{\hat{\Delta}}\\[8pt]
\end{bmatrix}
= \frac{1}{\hat{\Delta}}\begin{bmatrix}
1 & 0 & -\hat{b} \\[8pt]
0 & \dfrac{\hat{\Delta}}{\hat{c}} & 0 \\[8pt]
-\hat{d} & 0 & \hat{a}\\[8pt]
\end{bmatrix}
$$


## $x$ Shear Versus $z$ Shear

TODO

## Preconditioning Roughness and Viewing angle
TODO

